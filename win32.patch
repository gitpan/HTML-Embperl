Return-Path: modperl-cvs-owner-richter=ecos.de@apache.org
Received: from hyperreal.org (taz.hyperreal.org [204.62.130.147]) by merkur.ecos.de (8.7.5/8.7.3) with SMTP id HAA24454 for <richter@ecos.de>; Thu, 23 Apr 1998 07:14:49 +0200
Received: (qmail 26964 invoked by uid 6000); 23 Apr 1998 05:14:45 -0000
Received: (qmail 26957 invoked by uid 169); 23 Apr 1998 05:14:43 -0000
Date: 23 Apr 1998 05:14:43 -0000
Message-ID: <19980423051443.26956.qmail@hyperreal.org>
From: dougm@hyperreal.org
To: modperl-cvs@hyperreal.org
Subject: cvs commit: modperl/t/internal http-get.t
Sender: modperl-cvs-owner@apache.org
Precedence: bulk
Reply-To: modperl-cvs@apache.org
X-UIDL: 9e6f32d30cd93cdb164533b619c0f9f5

dougm       98/04/22 22:14:43

  Modified:    .        Changes MANIFEST ToDo mod_perl.pod
               lib      mod_perl.pm
               lib/Apache ExtUtils.pm test.pm
               src/modules/perl mod_perl.c mod_perl.h perl_config.c
               t/conf   httpd.conf-dist
               t/internal http-get.t
  Log:
  widen scope of mutex lock under win32 to avoid possible deadlock
  [Gerald Richter <richter@ecos.de>]
  
  fixed bug in directory_merge where FLAG directives would inherit `On'
  from the base configuration, even if the directory explicitly had the
  flag turned `Off', this was the case for PerlSendHeader and
  PerlSetupEnv.  thanks to Mark-Jason Dominus for the spot.
  
  added `grab' function to Apache::test, which fetches a url and gives
  diagnostics as to validity of the HTTP response
  (a test for properly formatted headers!)
  
  Revision  Changes    Path
  1.15      +14 -0     modperl/Changes
  
  Index: Changes
  ===================================================================
  RCS file: /export/home/cvs/modperl/Changes,v
  retrieving revision 1.14
  retrieving revision 1.15
  diff -u -r1.14 -r1.15
  --- Changes	1998/04/21 11:02:09	1.14
  +++ Changes	1998/04/23 05:14:34	1.15
  @@ -16,6 +16,20 @@
   
   =over 3
   
  +=item 1.11_01-dev
  +
  +widen scope of mutex lock under win32 to avoid possible deadlock
  +[Gerald Richter <richter@ecos.de>]
  +
  +fixed bug in directory_merge where FLAG directives would inherit `On'
  +from the base configuration, even if the directory explicitly had the
  +flag turned `Off', this was the case for PerlSendHeader and
  +PerlSetupEnv.  thanks to Mark-Jason Dominus for the spot.
  +
  +added `grab' function to Apache::test, which fetches a url and gives
  +diagnostics as to validity of the HTTP response 
  +(a test for properly formatted headers!)
  +
   =item 1.11 - April 21, 1998
   
   Apache::SIG enhancements for LogFormat [Doug Bagley <doug@dejanews.com>]
  
  
  
  1.9       +1 -0      modperl/MANIFEST
  
  Index: MANIFEST
  ===================================================================
  RCS file: /export/home/cvs/modperl/MANIFEST,v
  retrieving revision 1.8
  retrieving revision 1.9
  diff -u -r1.8 -r1.9
  --- MANIFEST	1998/04/21 08:16:58	1.8
  +++ MANIFEST	1998/04/23 05:14:35	1.9
  @@ -112,6 +112,7 @@
   t/net/perl/io/ssi1.pl
   t/net/perl/io/ssi2.pl
   t/net/perl/io/include.pl	
  +t/net/perl/noenv/test.pl
   lib/Apache/RedirectLogFix.pm
   lib/Apache/Include.pm
   lib/Apache/Status.pm
  
  
  
  1.9       +0 -2      modperl/ToDo
  
  Index: ToDo
  ===================================================================
  RCS file: /export/home/cvs/modperl/ToDo,v
  retrieving revision 1.8
  retrieving revision 1.9
  diff -u -r1.8 -r1.9
  --- ToDo	1998/04/21 11:02:10	1.8
  +++ ToDo	1998/04/23 05:14:35	1.9
  @@ -18,8 +18,6 @@
   
   - Ralf's APACI Makefile.tmpl
   
  -- Gerald's suggestion to avoid possible deadlock under win32
  -
   ---------------------------------------------------------------------------
   DOCUMENTATION (areas that *really* need some)
   ---------------------------------------------------------------------------
  
  
  
  1.6       +6 -1      modperl/mod_perl.pod
  
  Index: mod_perl.pod
  ===================================================================
  RCS file: /export/home/cvs/modperl/mod_perl.pod,v
  retrieving revision 1.5
  retrieving revision 1.6
  diff -u -r1.5 -r1.6
  --- mod_perl.pod	1998/03/19 23:08:21	1.5
  +++ mod_perl.pod	1998/04/23 05:14:36	1.6
  @@ -697,6 +697,11 @@
   
    <!--#perl sub="Package::handler" arg="one" arg="two" -->
   
  + #don't forget to escape double quotes!
  + Perl is
  +        <!--#perl sub="sub {for (0..10) {print \"very \"}}"-->
  +        fun to use!
  +
   The B<Apache::Include> module makes it simple to include
   B<Apache::Registry> scripts with the mod_include perl directive. 
   
  @@ -802,7 +807,7 @@
   
   =head1 REVISION
   
  -$Id: mod_perl.pod,v 1.5 1998/03/19 23:08:21 dougm Exp $
  +$Id: mod_perl.pod,v 1.6 1998/04/23 05:14:36 dougm Exp $
   
   =head1 AUTHOR
   
  
  
  
  1.10      +1 -1      modperl/lib/mod_perl.pm
  
  Index: mod_perl.pm
  ===================================================================
  RCS file: /export/home/cvs/modperl/lib/mod_perl.pm,v
  retrieving revision 1.9
  retrieving revision 1.10
  diff -u -r1.9 -r1.10
  --- mod_perl.pm	1998/04/21 11:02:12	1.9
  +++ mod_perl.pm	1998/04/23 05:14:39	1.10
  @@ -3,7 +3,7 @@
   use strict;
   
   BEGIN {
  -    $mod_perl::VERSION = "1.11";
  +    $mod_perl::VERSION = "1.1101";
   }
   
   sub subversion {
  
  
  
  1.3       +1 -1      modperl/lib/Apache/ExtUtils.pm
  
  Index: ExtUtils.pm
  ===================================================================
  RCS file: /export/home/cvs/modperl/lib/Apache/ExtUtils.pm,v
  retrieving revision 1.2
  retrieving revision 1.3
  diff -u -r1.2 -r1.3
  --- ExtUtils.pm	1998/04/21 08:16:59	1.2
  +++ ExtUtils.pm	1998/04/23 05:14:39	1.3
  @@ -46,7 +46,7 @@
       NULL,   /* [1] post read_request handling */
   };
   
  -MODULE = $modname		PACKAGE = $modname
  +MODULE = $class		PACKAGE = $class
   
   BOOT:
       add_module(&XS_${modname});
  
  
  
  1.6       +58 -1     modperl/lib/Apache/test.pm
  
  Index: test.pm
  ===================================================================
  RCS file: /export/home/cvs/modperl/lib/Apache/test.pm,v
  retrieving revision 1.5
  retrieving revision 1.6
  diff -u -r1.5 -r1.6
  --- test.pm	1998/03/19 23:08:49	1.5
  +++ test.pm	1998/04/23 05:14:40	1.6
  @@ -7,7 +7,7 @@
   *import = \&Exporter::import;
   
   @EXPORT = qw(test fetch simple_fetch have_module skip_test 
  -	     $USE_THREAD WIN32); 
  +	     $USE_THREAD WIN32 grab); 
   
   BEGIN { 
       if(not $ENV{MOD_PERL}) {
  @@ -179,6 +179,63 @@
   
   $my_test;
   
  +}
  +
  +sub grab {
  +    require IO::Socket;
  +    my(@args) = @_;
  +    @args = @ARGV unless @args;
  +
  +    unless (@args > 0) { 
  +	die "usage: grab host:port path";
  +    }
  +
  +    my($host, $port) = split ":", shift @args;
  +    $port ||= 80;
  +    my $url = shift @args || "/";
  +
  +    my $remote = IO::Socket::INET->new(Proto     => "tcp",
  +				       PeerAddr  => $host,
  +				       PeerPort  => $port,
  +				       );
  +    unless ($remote) {
  +	die "cannot connect to http daemon on $host"; 
  +    }
  +    $remote->autoflush(1);
  +    print $remote "GET $url HTTP/1.0\n\n";
  +    my $response_line = 0;
  +    my $header_terminator = 0;
  +    my @msg = ();
  +
  +    while ( <$remote> ) {
  +	#e.g. HTTP/1.1 200 OK
  +	if(m:^(HTTP/\d+\.\d+)[ \t]+(\d+)[ \t]*([^\012]*):i) {
  +	    push @msg, $_;
  +	    $response_line = 1;
  +	}
  +	elsif(/^([a-zA-Z0-9_\-]+)\s*:\s*(.*)/) {
  +	    push @msg, $_;
  +	}
  +	elsif(/^\015?\012$/) {
  +	    $header_terminator = 1;
  +	    push @msg, $_;
  +	}
  +
  +	print;
  +    }
  +    close $remote;
  +
  +    print "~" x 40, "\n", "Diagnostics:\n";
  +    if ($response_line and $header_terminator) {
  +	print " HTTP response is valid:\n";
  +    }
  +    else {
  +	print "     GET -> http://$host:$port$url\n";
  +	print " >>> No response line\n" unless $response_line;
  +	print " >>> No header terminator\n" unless $header_terminator;
  +	print " *** HTTP response is malformed\n";
  +    }
  +    print "-" x 40, "\n", @msg, "-" x 40, "\n";
   }
   
   1;
  
  
  
  1.13      +2 -1      modperl/src/modules/perl/mod_perl.c
  
  Index: mod_perl.c
  ===================================================================
  RCS file: /export/home/cvs/modperl/src/modules/perl/mod_perl.c,v
  retrieving revision 1.12
  retrieving revision 1.13
  diff -u -r1.12 -r1.13
  --- mod_perl.c	1998/04/21 11:02:14	1.12
  +++ mod_perl.c	1998/04/23 05:14:40	1.13
  @@ -748,7 +748,6 @@
   
   void mod_perl_end_cleanup(void *data)
   {
  -    (void)acquire_mutex(mod_perl_mutex); 
       MP_TRACE_g(fprintf(stderr, "perl_end_cleanup..."));
   
       /* clear %ENV */
  @@ -1008,6 +1007,8 @@
   	mod_perl_pass_env(r->pool, cls);
       }
   
  +    /* will be released in mod_perl_end_cleanup */
  +    (void)acquire_mutex(mod_perl_mutex); 
       register_cleanup(r->pool, NULL, mod_perl_end_cleanup, mod_perl_noop);
   
       /* hookup stderr to error_log */
  
  
  
  1.11      +18 -2     modperl/src/modules/perl/mod_perl.h
  
  Index: mod_perl.h
  ===================================================================
  RCS file: /export/home/cvs/modperl/src/modules/perl/mod_perl.h,v
  retrieving revision 1.10
  retrieving revision 1.11
  diff -u -r1.10 -r1.11
  --- mod_perl.h	1998/04/20 23:06:02	1.10
  +++ mod_perl.h	1998/04/23 05:14:41	1.11
  @@ -201,6 +201,10 @@
   
   /* per-directory flags */
   
  +#define MPf_On   1
  +#define MPf_Off -1
  +#define MPf_None 0
  +
   #define MPf_INCPUSH	0x00000100 /* use lib split ":", $ENV{PERL5LIB} */
   #define MPf_SENDHDR	0x00000200 /* is PerlSendHeader On? */
   #define MPf_SENTHDR	0x00000400 /* has PerlSendHeader sent the headers? */
  @@ -218,17 +222,29 @@
   #define MP_INCPUSH_on(d)  (d->flags |= MPf_INCPUSH)
   #define MP_INCPUSH_off(d)  (d->flags  &= ~MPf_INCPUSH)
   
  +#if 0
   #define MP_SENDHDR(d)    (d->flags & MPf_SENDHDR)
   #define MP_SENDHDR_on(d)  (d->flags |= MPf_SENDHDR)
   #define MP_SENDHDR_off(d)  (d->flags  &= ~MPf_SENDHDR)
  +#endif
  +
  +#define MP_SENDHDR(d)     (d->SendHeader == MPf_On)
  +#define MP_SENDHDR_on(d)  (d->SendHeader = MPf_On)
  +#define MP_SENDHDR_off(d) (d->SendHeader = MPf_Off)
   
   #define MP_SENTHDR(d)    (d->flags & MPf_SENTHDR)
   #define MP_SENTHDR_on(d)  (d->flags |= MPf_SENTHDR)
   #define MP_SENTHDR_off(d)  (d->flags  &= ~MPf_SENTHDR)
   
  +#if 0
   #define MP_ENV(d)       (d->flags & MPf_ENV)
   #define MP_ENV_on(d)     (d->flags |= MPf_ENV)
   #define MP_ENV_off(d)    (d->flags  &= ~MPf_ENV)
  +#endif
  +
  +#define MP_ENV(d)       (d->SetupEnv == MPf_On)
  +#define MP_ENV_on(d)    (d->SetupEnv = MPf_On)
  +#define MP_ENV_off(d)   (d->SetupEnv = MPf_Off)
   
   #define MP_HASENV(d)    (d->flags & MPf_HASENV)
   #define MP_HASENV_on(d)  (d->flags |= MPf_HASENV)
  @@ -385,7 +401,6 @@
   
   #define PERL_CALLBACK(h,name) \
   PERL_SET_CUR_HOOK(h); \
  -(void)acquire_mutex(mod_perl_mutex); \
   status = perl_run_stacked_handlers(h, r, Nullav); \
   if((status != OK) && (status != DECLINED)) { \
       MP_TRACE_h(fprintf(stderr, "%s handlers returned %d\n", h, status)); \
  @@ -393,7 +408,6 @@
   else if(AvTRUE(name)) { \
       status = perl_run_stacked_handlers(h, r, name); \
   } \
  -(void)release_mutex(mod_perl_mutex); \
   MP_TRACE_h(fprintf(stderr, "%s handlers returned %d\n", h, status))
   
   
  @@ -754,6 +768,8 @@
       table *env;
       table *vars;
       U32 flags;
  +    int SendHeader;
  +    int SetupEnv;
   } perl_dir_config;
   
   typedef struct {
  
  
  
  1.9       +10 -2     modperl/src/modules/perl/perl_config.c
  
  Index: perl_config.c
  ===================================================================
  RCS file: /export/home/cvs/modperl/src/modules/perl/perl_config.c,v
  retrieving revision 1.8
  retrieving revision 1.9
  diff -u -r1.8 -r1.9
  --- perl_config.c	1998/04/21 11:02:15	1.8
  +++ perl_config.c	1998/04/23 05:14:41	1.9
  @@ -230,11 +230,17 @@
       new->vars = overlay_tables(p, add->vars, base->vars);
       new->env = overlay_tables(p, add->env, base->env);
   
  +    new->SendHeader = (add->SendHeader != MPf_None) ?
  +	add->SendHeader : base->SendHeader;
  +
  +    new->SetupEnv = (add->SetupEnv != MPf_None) ?
  +	add->SetupEnv : base->SetupEnv;
  +
       /* merge flags */
       MP_FMERGE(new,add,base,MPf_INCPUSH);
       MP_FMERGE(new,add,base,MPf_HASENV);
  -    MP_FMERGE(new,add,base,MPf_ENV);
  -    MP_FMERGE(new,add,base,MPf_SENDHDR);
  +    /*MP_FMERGE(new,add,base,MPf_ENV);*/
  +    /*MP_FMERGE(new,add,base,MPf_SENDHDR);*/
       MP_FMERGE(new,add,base,MPf_SENTHDR);
       MP_FMERGE(new,add,base,MPf_CLEANUP);
       MP_FMERGE(new,add,base,MPf_RCLEANUP);
  @@ -294,6 +300,8 @@
       cld->vars = make_table(p, 5); 
       cld->env  = make_table(p, 5); 
       cld->flags = MPf_ENV;
  +    cld->SendHeader = MPf_None;
  +    cld->SetupEnv = MPf_On;
       cld->PerlHandler = PERL_CMD_INIT;
       PERL_DISPATCH_CREATE(cld);
       PERL_AUTHEN_CREATE(cld);
  
  
  
  1.5       +16 -0     modperl/t/conf/httpd.conf-dist
  
  Index: httpd.conf-dist
  ===================================================================
  RCS file: /export/home/cvs/modperl/t/conf/httpd.conf-dist,v
  retrieving revision 1.4
  retrieving revision 1.5
  diff -u -r1.4 -r1.5
  --- httpd.conf-dist	1998/03/25 08:46:09	1.4
  +++ httpd.conf-dist	1998/04/23 05:14:42	1.5
  @@ -11,6 +11,13 @@
   
   =cut
   
  +#we do this to test that `PerlSendHeader Off' will work
  +<Files ~ "\.pl$">
  +   PerlHandler          Apache::Registry
  +   PerlSendHeader       On
  +   Options              ExecCGI
  +</Files>
  +
   #make sure all regex stuff works
   #BrowserMatch Mozilla/2 nokeepalive
   
  @@ -51,6 +58,15 @@
   SetHandler perl-script
   PerlHandler Apache::Registry::handler
   Options +ExecCGI
  +PerlSendHeader       Off
  +</Location>
  +
  +<Location /perl/noenv>
  +SetHandler perl-script
  +PerlHandler Apache::Registry::handler
  +Options +ExecCGI
  +PerlSendHeader       Off
  +PerlSetupEnv Off
   </Location>
   
   <Location /cgi-bin>
  
  
  
  1.2       +6 -2      modperl/t/internal/http-get.t
  
  Index: http-get.t
  ===================================================================
  RCS file: /export/home/cvs/modperl/t/internal/http-get.t,v
  retrieving revision 1.1
  retrieving revision 1.2
  diff -u -r1.1 -r1.2
  --- http-get.t	1997/12/06 17:57:14	1.1
  +++ http-get.t	1998/04/23 05:14:43	1.2
  @@ -3,7 +3,7 @@
   # Check GET via HTTP.
   #
   
  -my $num_tests = 7;
  +my $num_tests = 8;
   my(@test_scripts) = qw(test perl-status);
   %get_only = map { $_,1 } qw(perl-status);
   
  @@ -45,12 +45,16 @@
       test ++$i, ($str =~ /^QUERY_STRING=query$/m); 
   }
   
  +#test PerlSetupEnv Off
  +test ++$i, fetch("/perl/noenv/test.pl") !~ /SERVER_SOFTWARE/m;
  +
   print "pounding a bit...\n";
   for (1..3) {
       test ++$i, ($ua->request($request, undef, undef)->is_success);
   }
   
  -
   # avoid -w warning
   $dummy = $net::httpserver;
   $dummy = $net::perldir;
  +
  +
  
  
  
